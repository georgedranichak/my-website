---
pagination:
  data: archivePages
  size: 1
  alias: item
permalink: "/archive/{{ item.slug }}/index.html"
layout: layouts/base.njk
eleventyComputed:
  title: "{{ item.title }}"
---

<link rel="stylesheet" href="/css/archive.css">

<article class="card stack">
  <header class="stack">
    <h1 style="margin:0">{{ item.title }}</h1>
    <p class="muted" style="margin:0">
      <a href="/archive.html">← Back to Project Archive</a>
    </p>
  </header>

  <div id="pdfContainer" class="stack"></div>

  <noscript>
    <embed
      src="{{ item.file | url }}#toolbar=0"
      type="application/pdf"
      style="width:100%;height:80vh;border:1px solid var(--border);
             border-radius:8px;background:#111"
    >
  </noscript>
</article>

<script>
(function(){
  const cdn="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js";
  const worker="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js";
  const url = encodeURI("{{ item.file | url }}");

  function ensure(){
    return new Promise((res,rej)=>{
      if(window.pdfjsLib) return res();
      const s=document.createElement('script');
      s.src=cdn; s.onload=res; s.onerror=rej;
      document.head.appendChild(s);
    }).then(()=>{ window.pdfjsLib.GlobalWorkerOptions.workerSrc = worker; });
  }

  async function render(){
    const wrap = document.getElementById('pdfContainer');
    wrap.innerHTML = '<p class="muted">Loading preview…</p>';
    try {
      await ensure();
      const pdf = await window.pdfjsLib.getDocument({ url }).promise;
      wrap.innerHTML = "";
      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const base = page.getViewport({ scale: 1 });
        const maxW = Math.min(wrap.clientWidth || 900, 900);
        const scale = maxW / base.width;
        const vp = page.getViewport({ scale });

        const c = document.createElement('canvas');
        c.className = 'pdf-canvas';
        c.width = vp.width;
        c.height = vp.height;
        wrap.appendChild(c);

        await page.render({
          canvasContext: c.getContext('2d'),
          viewport: vp
        }).promise;
      }
    } catch (e) {
      console.error("PDF.js failed; falling back to <embed>", e);
      wrap.innerHTML =
        `<embed src="${url}#toolbar=0" type="application/pdf"
                style="width:100%;height:80vh;border:1px solid var(--border);
                       border-radius:8px;background:#111">`;
    }
  }
  render();
})();
</script>
